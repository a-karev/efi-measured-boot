#! /bin/bash

cmd=$0

exec 3>&1 1>&2

[ -r /etc/efi-measured-boot/config ] && . /etc/efi-measured-boot/config
if [[ $cmd = ./* ]]; then APPDIR=.; fi
. "${APPDIR:-.}"/functions
. "${APPDIR:-.}"/bash_functions

set -e

. "$(emboot_state_path)/state"

cleanup() {
    [ -n "$TMPDIR" ] && rm -rf "$TMPDIR"
}

trap cleanup EXIT

TMPDIR=$(setup_tmp_dir)

read_counter >"$TMPDIR"/counter
create_provision_context "$TMPDIR"

read_efi_vars

seal_to_loader "$TMPDIR" "$(emboot_loader_unix_path)" "$primary"
seal_to_loader "$TMPDIR" "$(emboot_loader_unix_path emboot_old.efi)" "$old"

exit 0
